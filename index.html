<meta name="robots" content="noindex,nofollow,noarchive,noimageindex,nosnippet">
<!doctype html>
<html lang="zh-Hant">
<head>
  <!-- 放在整份 <style> 的最尾端；或加一個新的 <style> 也行 -->
<style>
/* === Drawer / FAB 終極修補（請放在 <style> 最尾端）=== */

/* 1) 抽屜永遠壓過遮罩（覆蓋掉 html[data-mode="mobile"] .sidebar 的 120） */
html[data-mode="mobile"] .sidebar,
.sidebar { z-index: 1001 !important; isolation: isolate; }
.backdrop { z-index: 1000 !important; }

/* 2) 強制「手機模式」時也要看得到 FAB（不要放在 @media 裡） */
html[data-mode="mobile"]  .menu-fab { display:block !important; }
html[data-mode="desktop"] .menu-fab { display:none  !important; }

/* 3) 保險：側欄開啟時一定滑出來 */
.sidebar.open { transform: translateX(0) !important; }
/* === Drawer / FAB 終極修補（請放在 <style> 最尾端）=== */
html[data-mode="mobile"] .sidebar,
.sidebar { z-index: 1001 !important; isolation: isolate; }  /* 壓過 120 */
.backdrop { z-index: 1000 !important; }

/* 抽屜開啟時一定滑出來（避免 transform 被其他規則覆蓋） */
.sidebar.open { transform: translateX(0) !important; }

/* 強制模式下 FAB 顯示：不要寫在 @media 裡 */
html[data-mode="mobile"]  .menu-fab { display:block !important; }
html[data-mode="desktop"] .menu-fab { display:none  !important; }

</style>

<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>特寵飲食照顧注意事項（主頁）</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>

<style>
  :root{
    color-scheme: dark;
    --bg:#000; --panel:#111827; --line:#374151; --ink:#fff; --muted:#94a3b8;
    --brand:#60a5fa; --chip:#1f2937; --chip-b:#374151;
    --ui:1;
  }
  html,body{margin:0; background:var(--bg); color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"PingFang TC","Microsoft JhengHei","Noto Sans TC",sans-serif}
  body{font-size:calc(16px * var(--ui)); line-height:1.7; -webkit-text-size-adjust:100%}
  .topbar{position:sticky; top:0; z-index:100; background:rgba(0,0,0,.72); backdrop-filter:blur(10px); border-bottom:1px solid var(--line)}
  .topbar-inner{display:flex; align-items:center; gap:12px; padding:10px 12px}
  .brand{display:flex; align-items:center; gap:10px; font-weight:800}
  .brand .dot{width:10px; height:10px; border-radius:99px; background:var(--brand)}
  .brand .title{color:#c7d2fe}
  .grow{flex:1}
  .chip{background:var(--chip); border:1px solid var(--chip-b); color:var(--ink); padding:6px 10px; border-radius:999px; cursor:pointer}
  .chip.active{background:#4f46e5; border-color:#4338ca}
  .view-dock, .zoom-dock, .mode-dock{display:flex; gap:6px; align-items:center; flex-wrap:wrap}

  .shell{display:grid; grid-template-columns:260px 1fr; min-height:100vh}
  .sidebar{border-right:1px solid var(--line); padding:16px 12px; position:sticky; top:52px; align-self:start; height:calc(100vh - 52px); overflow:auto; background:var(--bg)}
  .nav{display:grid; gap:8px; margin-bottom:16px}
  .navlink{display:block; padding:8px 10px; border-radius:8px; background:transparent; border:1px solid var(--line); color:var(--ink); cursor:pointer; text-decoration:none}
  .navlink.active{background:#111827; border-color:#4338ca}
  .meta{display:grid; gap:10px; margin-top:16px; font-size:.95rem}
  .tag{color:var(--muted); font-size:.9rem}

  .content{padding:16px; max-width:1280px; width:100%}
  .panel{display:none}
  .panel.active{display:block}
  .card{background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:16px}
  .muted{color:var(--muted)}
  table{border-collapse:collapse; width:100%; font-size:.95rem}
  th,td{border:1px solid var(--line); padding:12px; vertical-align:top}
  thead th{background:#0b1220; position:sticky; top:0; z-index:1}
  table.responsive th:first-child, table.responsive td:first-child{ position:sticky; left:0; background:#0b1220; z-index:2; }

  .t-green{color:#22c55e}.t-yellow{color:#facc15}.t-red{color:#b91c1c}.t-redlite{color:#f87171}.t-sky{color:#7dd3fc}.t-purple{color:#d8b4fe}
  .scrollbox{position:relative; overflow:auto; -webkit-overflow-scrolling:touch; border:1px solid #30363d; border-radius:10px; background:#0b0b0b}
  .wider{min-width:1100px}
  .pager{position:sticky; bottom:0; display:flex; gap:8px; align-items:center; background:rgba(17,24,39,.78); border-top:1px solid var(--line); padding:10px 12px}
  .btn{padding:6px 10px; border:1px solid var(--chip-b); border-radius:10px; background:var(--chip); color:var(--ink); cursor:pointer; display:inline-flex; align-items:center; gap:6px}
  .btn.active{background:#4f46e5; border-color:#4338ca}
  a.link{ color:#60a5fa; text-decoration:none } a.link:hover{text-decoration:underline}

  /* —— 行動版抽屜側欄 —— */
  .menu-fab{position:fixed; left:12px; bottom:max(12px, env(safe-area-inset-bottom)); z-index:130; display:none}
  .backdrop{ position:fixed; inset:52px 0 0 0; background:rgba(0,0,0,.4); backdrop-filter:blur(2px); z-index:110; display:none }
  @media(max-width: 1023px){
    .shell{grid-template-columns:1fr}
    .sidebar{
      position:fixed; top:52px; bottom:0; left:0; width:min(82vw, 320px);
      transform:translateX(-105%); transition:transform .25s ease; z-index:120; display:block;
    }
    .sidebar.open{ transform:translateX(0) }
    .menu-fab{display:block}
  }
  .backdrop.show{ display:block }

  html[data-mode="mobile"] .shell{grid-template-columns:1fr}
  html[data-mode="mobile"] .sidebar{ position:fixed; top:52px; bottom:0; left:0; width:min(82vw, 320px); transform:translateX(-105%); transition:transform .25s ease; z-index:120; display:block }
  html[data-mode="desktop"] .shell{grid-template-columns:260px 1fr}
  html[data-mode="desktop"] .sidebar{position:sticky; transform:none}

  html.light{ --bg:#f8fafc; --panel:#ffffff; --line:#e5e7eb; --ink:#0f172a; --muted:#475569; --chip:#f1f5f9; --chip-b:#cbd5e1; }
  .swipehint{position:fixed; left:50%; transform:translateX(-50%); bottom:max(8px, env(safe-area-inset-bottom)); z-index:50;
    background:rgba(17,24,39,.78); border:1px solid var(--line); padding:6px 10px; border-radius:999px; color:var(--muted); font-size:.9rem}

  @media (max-width: 900px){
    html:not([data-mode="desktop"]) .wider{ min-width: unset !important; }
    html:not([data-mode="desktop"]) .pager{ display:none !重要; }
    html:not([data-mode="desktop"]) table.responsive{ display:block !重要; }
    html:not([data-mode="desktop"]) table.responsive thead{ display:none !重要; }
    html:not([data-mode="desktop"]) table.responsive tbody{ display:block !重要; }
    html:not([data-mode="desktop"]) table.responsive tr{
      display:block !重要; margin:12px 0 !重要; border:1px solid var(--line) !重要;
      border-radius:12px !重要; background:#0b0b0b !重要;
    }
    html:not([data-mode="desktop"]) table.responsive td{
      display:flex !重要; gap:10px !重要; border:none !重要; border-bottom:1px solid var(--line) !重要;
      padding:10px 12px !重要; align-items:flex-start !重要;
    }
    html:not([data-mode="desktop"]) table.responsive td:last-child{ border-bottom:none !重要; }
    html:not([data-mode="desktop"]) table.responsive td::before{
      content: attr(data-label) !重要; flex:0 0 6.5rem !重要; color:var(--muted) !重要; font-weight:600 !重要;
    }
    html:not([data-mode="desktop"]) table.responsive td[data-label="物種分群"]{ font-weight:700; font-size:1.05rem; }
  }

  /* —— 圖表 UI —— */
  #chartBox{position:relative}
  #chartCanvas{ width:100% !important; max-width:600px; height:auto !important; display:block; margin:auto; }
  html[data-ctype="bar"]  #chartCanvas{ aspect-ratio:16/10; }
  html[data-ctype="pie"]  #chartCanvas{ aspect-ratio:1/1; }
  .legend{display:grid;gap:10px}
  .legend .item{display:flex;align-items:center;gap:10px;cursor:pointer}
  .dot{width:10px;height:10px;border-radius:50%}
  .i-green{background:#22c55e}.i-yellow{background:#facc15}.i-red{background:#b91c1c}.i-redlite{background:#f87171}
  .blocks{display:grid;gap:14px}
  .blk{border:1px solid var(--line);border-radius:12px;padding:14px;background:#0b0b0b}
  .blk h4{margin:0 0 6px}
  .blk.green{background:linear-gradient(0deg,#0e2016,#0e2016)}
  .blk.yellow{background:linear-gradient(0deg,#201e0c,#201e0c)}
  .blk.red{background:linear-gradient(0deg,#211013,#211013)}
  .blk.redlite{background:linear-gradient(0deg,#1f1315,#1f1315)}
  .hl{outline:2px solid #7dd3fc; outline-offset:2px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap}
  .speciesBar{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:14px}
  .title{font-size:22px;font-weight:800;margin:0 0 4px}
  .note{
    position:absolute; left:0; top:0; transform:translate(-50%,-110%);
    background:#0b1220cc; border:1px solid var(--line); color:var(--ink);
    padding:8px 10px; border-radius:10px; font-size:14px; max-width:320px;
    backdrop-filter:blur(6px); pointer-events:none; z-index:3;
    box-shadow:0 6px 20px rgba(0,0,0,.35);
  }
  .note .head{display:flex;align-items:center;gap:8px;font-weight:700;margin-bottom:4px}
  @media (max-width:640px){
    html[data-ctype="bar"] #chartCanvas{aspect-ratio:4/3}
  }

/* Drawer 層級修補 */
.sidebar { z-index: 1001; isolation: isolate; }
.backdrop { z-index: 1000; }
.sidebar.open { transform: translateX(0) !important; }

/* 某些機型對 backdrop-filter 有疊層 bug：行動端移除模糊但保留遮罩 */
@media (max-width: 1023px){
  .backdrop.show { backdrop-filter: none; background: rgba(0,0,0,.45); }
}
/* 強制模式下 FAB 顯示規則（不要放在 @media 裡） */
html[data-mode="mobile"]  .menu-fab { display:block !important; }
html[data-mode="desktop"] .menu-fab { display:none  !important; }
</style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand">
        <span class="dot"></span>
        <span class="title">特寵飲食照顧注意事項（主頁）</span>
      </div>
      <div class="grow"></div>
        <button id="toApps" class="chip" title="回切換 App" aria-label="回切換 App">↩︎ 切換 App</button>
      <div class="view-dock" aria-label="檢視切換">
        <button class="chip" data-view="table" title="表格" aria-pressed="true">表格</button>
        <button class="chip" data-view="bar"   title="長條圖" aria-pressed="false">長條</button>
        <button class="chip" data-view="pie"   title="圓餅圖" aria-pressed="false">圓餅</button>
      </div>
      <div class="zoom-dock" aria-label="縮放">
        <button id="fontDec" class="chip" title="字體縮小">A−</button>
        <button id="fontInc" class="chip" title="字體放大">A＋</button>
        <button id="resetAll" class="chip" title="重置">↺</button>
      </div>
      <div class="mode-dock" aria-label="裝置模式">
        <button id="modeAuto" class="chip">自動</button>
        <button id="modeMobile" class="chip">手機</button>
        <button id="modeDesktop" class="chip">桌機</button>
      </div>
    </div>
  </header>

  <div class="shell">
    <aside class="sidebar" id="sidebar" role="navigation" aria-label="側欄">
      <nav class="nav">
        <a class="navlink active" data-section="apps">1 切換 App</a>
        <a class="navlink" data-section="intro">2 簡介</a>
        <a class="navlink" data-section="risks">3 疾病風險 / 基因缺陷</a>
        <a class="navlink" data-section="diet">4 特寵飲食注意事項（圖表/表格）</a>
        <a class="navlink" data-section="sources">5 來源資料</a>
        <a class="navlink" data-section="summary">6 總結</a>
      </nav>
      <div class="meta">
        <div>更新：<span id="now"></span></div>
        <button id="toggleDark" class="chip">深色 UI</button>
        <div class="mode-dock">
          <button id="mAuto" class="chip">自動</button>
          <button id="mMobile" class="chip">手機</button>
          <button id="mDesktop" class="chip">桌機</button>
        </div>
        <div class="tag">從左邊緣右滑或點「目錄」開啟</div>
      </div>
    </aside>

    <main class="content" id="content" tabindex="-1">
      <!-- 1 切換 App -->
      <section class="panel active" data-panel="apps">
        <div class="card">
          <h2>1｜切換 App</h2>
          <p class="muted">三個按鈕分別開新分頁。</p>
          <div style="display:flex;flex-wrap:wrap;gap:10px">
            <a class="btn" href="./fmg4/index.html" target="_blank" rel="noopener">
              <i class="fa-solid fa-chart-line"></i> 特寵趨勢 app
            </a>
            <a class="btn" href="./raw/index.html" target="_blank" rel="noopener">
              <i class="fa-solid fa-flask"></i> 特寵全方位米知毛研益生菌成分表
            </a>
            <a class="btn" href="./lab/index.html" target="_blank" rel="noopener">
              <i class="fa-solid fa-wrench"></i> 待開發
            </a>
          </div>
        </div>
      </section>

      <!-- 2 簡介 -->
      <section class="panel" data-panel="intro">
        <div class="card">
          <h2>2｜簡介</h2>
          <p>開發研究專用app網頁切換apps觀看其餘資料</p>
        </div>
      </section>

      <!-- 3 疾病風險／基因缺陷 -->
      <section class="panel" data-panel="risks">
        <div class="card">
          <h2>3｜疾病風險／基因缺陷</h2>
          <p class="muted">依常見特寵分群彙整。實際診療仍以專科獸醫判讀為準。</p>
          <div class="scrollbox">
            <div class="wider">
              <table class="responsive">
                <thead>
                  <tr>
                    <th>物種分群</th>
                    <th>常見疾病／營養症</th>
                    <th>基因缺陷／爭議品系</th>
                  </tr>
                </thead>
                <tbody id="riskBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- 4 飲食注意事項（原表/圖） -->
      <section class="panel" data-panel="diet">
        <div class="card">
          <h2>4｜特寵飲食注意事項（表格/長條/圓餅）</h2>
          <p class="muted">支援段位跳轉 1/2/3、字級縮放，以及圖表類型切換。</p>

          <!-- 表格視圖 -->
          <div id="view-table">
            <div class="scrollbox" id="sb-table">
              <div class="wider">
                <table class="responsive">
                  <thead>
                    <tr>
                      <th>物種分群</th>
                      <th class="t-green">必需</th>
                      <th class="t-yellow">可選</th>
                      <th><span class="t-red">⛔ 避免</span> / <span class="t-redlite">⚠️ 不建議</span></th>
                      <th class="t-sky">給法</th>
                      <th class="t-purple">節奏</th>
                    </tr>
                  </thead>
                  <tbody id="tbody"></tbody>
                </table>
              </div>
              <div class="pager" data-pager="#sb-table">
                <span class="muted">左右跳：</span>
                <button class="btn" data-dir="left"  data-step="1"><i class="fa-solid fa-angles-left"></i> 1</button>
                <button class="btn" data-dir="left"  data-step="2"><i class="fa-solid fa-angle-left"></i> 2</button>
                <button class="btn" data-dir="left"  data-step="3"><i class="fa-solid fa-chevron-left"></i> 3</button>
                <button class="btn" data-dir="right" data-step="1">1 <i class="fa-solid fa-angles-right"></i></button>
                <button class="btn" data-dir="right" data-step="2">2 <i class="fa-solid fa-angle-right"></i></button>
                <button class="btn" data-dir="right" data-step="3">3 <i class="fa-solid fa-chevron-right"></i></button>
              </div>
            </div>
          </div>

          <!-- 圖表視圖 -->
          <div id="view-chart" style="display:none">
            <div class="scrollbox" id="sb-chart">
              <div class="wider" style="padding:12px">
                <div class="row" style="display:flex;gap:16px;align-items:center;flex-wrap:wrap">
                  <div>
                    <div class="title">圖表切換</div>
                    <div class="muted">目前顯示：<span id="currentName">—</span></div>
                  </div>
                  <div class="toolbar" id="cToolbar" aria-label="圖表類型">
                    <button class="btn" data-ctype="bar">長條</button>
                    <button class="btn" data-ctype="pie">圓餅</button>
                  </div>
                </div>

                <div class="hstack" style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap; margin-top:14px">
                  <div class="col" id="chartBox" style="flex:1;min-width:260px">
                    <canvas id="chartCanvas"></canvas>
                    <div id="note" class="note" hidden></div>
                  </div>
                  <div class="col legend" id="legendBox" style="flex:1;min-width:260px">
                    <div class="muted" style="margin-bottom:6px">圖例（點擊高亮卡片 / 在圖上顯示註解）</div>
                    <div class="item" data-key="essential"><span class="dot i-green"></span><div>必需 — <span class="muted" id="l-eg"></span></div></div>
                    <div class="item" data-key="optional"><span class="dot i-yellow"></span><div>可選 — <span class="muted" id="l-op"></span></div></div>
                    <div class="item" data-key="avoid"><span class="dot i-red"></span><div>避免 — <span class="muted" id="l-av"></span></div></div>
                    <div class="item" data-key="not"><span class="dot i-redlite"></span><div>不建議 — <span class="muted" id="l-no"></span></div></div>
                  </div>
                </div>

                <div class="card" style="margin-top:14px; background:transparent; border:none; padding:0">
                  <div class="blocks" id="blocks"></div>
                </div>

                <div class="card" style="margin-top:14px; background:transparent; border:none; padding:0">
                  <div class="speciesBar" id="speciesChips"></div>
                </div>
              </div>

              <div class="pager" data-pager="#sb-chart">
                <span class="muted">左右跳：</span>
                <button class="btn" data-dir="left"  data-step="1"><i class="fa-solid fa-angles-left"></i> 1</button>
                <button class="btn" data-dir="left"  data-step="2"><i class="fa-solid fa-angle-left"></i> 2</button>
                <button class="btn" data-dir="left"  data-step="3"><i class="fa-solid fa-chevron-left"></i> 3</button>
                <button class="btn" data-dir="right" data-step="1">1 <i class="fa-solid fa-angles-right"></i></button>
                <button class="btn" data-dir="right" data-step="2">2 <i class="fa-solid fa-angle-right"></i></button>
                <button class="btn" data-dir="right" data-step="3">3 <i class="fa-solid fa-chevron-right"></i></button>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- 5 來源資料 -->
      <section class="panel" data-panel="sources">
        <div class="card">
          <h2>5｜來源資料</h2>
          <ul id="dev-refs"></ul>
        </div>
      </section>

      <!-- 6 總結 -->
      <section class="panel" data-panel="summary">
        <div class="card">
          <h2>6｜總結</h2>
          <ul class="bullets">
            <li><b>品類策略：</b>以「營養風險最高的族群」做切入（草食型爬蟲、蜜袋鼯、幼體/換飼期），標準化 Ca/D3 與纖維方案。</li>
            <li><b>產品矩陣：</b>Ca/D3、UVB知識卡、益生菌（耐熱株）、電解質；按物種貼標。</li>
            <li><b>商機：</b>教育＋配方雙輪：用圖表視覺化「錯誤餵食→疾病風險」，帶出配方升級。</li>
          </ul>
        </div>
      </section>
    </main>
  </div>

  <!-- 行動版：背景遮罩 + 目錄 FAB -->
  <div class="backdrop" id="backdrop" aria-hidden="true"></div>
  <button id="menuFab" class="menu-fab chip" aria-controls="sidebar" aria-expanded="false" title="開啟目錄">📑 目錄</button>

  <div class="swipehint">← 左右滑可換分頁；由左邊緣右滑可開啟目錄</div>

<script>
/* ====== 固定資料（飲食表/圖） ====== */
const DATA = {
  "昆蟲食蜥蜴/守宮": { essential: 2, optional: 2, avoid: 1, not: 1, details: {
    essential:"鈣 + UVB/D3", optional:"低頻綜合維他命、益生菌", avoid:"⛔ 魚油/肝油", not:"⚠️ 狗貓糧" } },
  "草食蜥蜴/陸龜": { essential: 3, optional: 2, avoid: 2, not: 1, details: {
    essential:"高纖草本主食 + 鈣粉 + UVB", optional:"低頻維他命、電解質", avoid:"⛔ 高蛋白/高脂、⛔ 過量水果、⚠️ 魚油/肝油", not:"" } },
  "水龜/半水龜": { essential: 3, optional: 2, avoid: 1, not: 1, details: {
    essential:"均衡飼料 + 鈣源 + 日照/UVB", optional:"低頻綜合維他命、益生菌", avoid:"⛔ 狗貓糧", not:"⚠️ 肝油" } },
  "蛇": { essential: 1, optional: 1, avoid: 1, not: 1, details: {
    essential:"完整獵物", optional:"（僅非常態食譜時低頻維他命）", avoid:"⛔ 魚油/肝油", not:"⚠️ 碎肉長期餵" } },
  "兔/天竺鼠/龍貓": { essential: 2, optional: 2, avoid: 2, not: 1, details: {
    essential:"無限草 + 高纖顆粒、Vit C（天竺鼠）", optional:"益生菌、電解質", avoid:"⛔ 高脂、⛔ 高糖零食", not:"⚠️ 魚油" } },
  "蜜袋鼯": { essential: 3, optional: 2, avoid: 1, not: 1, details: {
    essential:"Ca:P>1.5:1、配方膳 + 昆蟲、D3", optional:"低頻維他命、電解質", avoid:"⛔ 高糖漿", not:"⚠️ 高脂油" } },
  "蠍/蜘蛛": { essential: 2, optional: 0, avoid: 1, not: 1, details: {
    essential:"餌蟲營養化（gut-loading）+ 乾淨水", optional:"—", avoid:"⛔ 直接灑維他命", not:"⚠️ 油脂點餌" } },
};
const COLORS = { essential:"#22c55e", optional:"#facc15", avoid:"#b91c1c", not:"#f87171" };

/* ====== 疾病風險／基因缺陷（渲染資料） ====== */
const RISKS = {
  "昆蟲食蜥蜴/守宮": {
    diseases: [
      "代謝性骨病（MBD）— Ca/D3/UVB 不足造成骨鈣流失、骨骼軟弱",
      "脫皮不全（dysecdysis）、口炎/呼吸道感染",
      "隱孢子蟲（Cryptosporidium varanii）造成消瘦/拉稀（俗稱 stick tail）"
    ],
    genetics: [
      "豹紋守宮 Enigma 相關神經症候群（旋轉/轉圈等，屬爭議品系）"
    ]
  },
  "草食蜥蜴/陸龜": {
    diseases: [
      "代謝性骨病（MBD）",
      "背甲金字塔（pyramiding）— 高蛋白/低濕度/不當環境相關",
      "維生素A缺乏、呼吸道感染、膿腫"
    ],
    genetics: [
      "陸龜常見為飼養環境問題，無特定遺傳品系議題"
    ]
  },
  "水龜/半水龜": {
    diseases: [
      "MBD與膳食/UVB失衡",
      "背甲/皮膚感染（shell rot）、寄生蟲",
      "維生素A缺乏導致眼鼻問題"
    ],
    genetics: ["水龜較少見品系缺陷"]
  },
  "蛇": {
    diseases: [
      "呼吸道感染、消化不良、拒食",
      "含體病（IBD，boid inclusion body disease）"
    ],
    genetics: [
      "球蟒「蜘蛛（Spider）」等品系 wobble（前庭/內耳結構差異）",
      "地毯蟒 Jaguar 基因 wobble；雙劑量形式多致死"
    ]
  },
  "兔/天竺鼠/龍貓": {
    diseases: [
      "胃腸停滯（GI stasis）與低纖、高糖零食相關",
      "齒列不正（臼齒尖刺）、肥胖",
      "母兔子宮腺癌（未絕育發生率高）",
      "天竺鼠維生素C缺乏（壞血病）；龍貓易中暑"
    ],
    genetics: ["部分品系腫瘤傾向（如寵鼠）；兔長毛/矮種需注意牙齒結構問題"]
  },
  "蜜袋鼯": {
    diseases: [
      "營養性骨病（Ca:P 失衡、D3不足）→ 後肢無力/麻痺",
      "肥胖、牙周病、壓力相關自殘"
    ],
    genetics: ["部分花色系（白子/淡色）繁殖需注意遺傳多樣性"]
  },
  "蠍/蜘蛛": {
    diseases: [
      "脫水與蛻皮障礙（低濕度）",
      "（狼蛛）DKS 失調症候群：成因未明，症狀為運動失調"
    ],
    genetics: ["無明確馴化品系缺陷；以環境因子為主"]
  }
};

/* ====== 面板 / 導覽 ====== */
const panels = Array.from(document.querySelectorAll('.panel'));
const navlinks = Array.from(document.querySelectorAll('.navlink'));
function showPanel(name){
  panels.forEach(p=>p.classList.toggle('active', p.dataset.panel===name));
  navlinks.forEach(a=>a.classList.toggle('active', a.dataset.section===name));
}
document.addEventListener('click', e=>{
  const a=e.target.closest('.navlink'); if(a){ showPanel(a.dataset.section); }
});

/* ====== 檢視切換（頂部 chips） ====== */
const viewChips = Array.from(document.querySelectorAll('.view-dock .chip'));
let currentView = 'table';
let currentChartType = 'bar';
function setPressed(v){
  viewChips.forEach(c=>{
    const on = c.dataset.view===v;
    c.classList.toggle('active', on);
    c.setAttribute('aria-pressed', on);
  });
}
function applyView(v){
  currentView = v;
  setPressed(v);
  const isTable = (v==='table');
  document.getElementById('view-table').style.display = isTable ? '' : 'none';
  document.getElementById('view-chart').style.display = isTable ? 'none' : '';
  if(!isTable){
    currentChartType = (v==='bar' || v==='pie') ? v : currentChartType;
    ensureChartApp();
    setChartType(currentChartType);
  }
  location.hash = `view=${v}`;
}
document.querySelector('.view-dock').addEventListener('click', e=>{
  const c=e.target.closest('.chip[data-view]'); if(!c) return;
  applyView(c.dataset.view);
});
window.addEventListener('hashchange', ()=>{
  const m = location.hash.match(/view=(\w+)/);
  if(m) applyView(m[1]);
});

/* ====== 字級縮放 / 重置 ====== */
const setUI = v => { document.documentElement.style.setProperty('--ui', v); localStorage.setItem('ui', v); };
const uiInit = localStorage.getItem('ui') || '1'; setUI(uiInit);
document.getElementById('fontDec').onclick=()=>setUI(Math.max(0.9,(+getComputedStyle(document.documentElement).getPropertyValue('--ui')||1)-0.05).toFixed(2));
document.getElementById('fontInc').onclick=()=>setUI(Math.min(1.4,(+getComputedStyle(document.documentElement).getPropertyValue('--ui')||1)+0.05).toFixed(2));
document.getElementById('resetAll').onclick=()=>{ setUI(1); };

/* ====== 模式切換（穩定版） ====== */
(function () {
  const root = document.documentElement;

  const sidebar  = document.getElementById('sidebar');
  const backdrop = document.getElementById('backdrop');
  const menuFab  = document.getElementById('menuFab');

  const btn = {
    auto:     document.getElementById('modeAuto'),
    mobile:   document.getElementById('modeMobile'),
    desktop:  document.getElementById('modeDesktop'),
    mAuto:    document.getElementById('mAuto'),
    mMobile:  document.getElementById('mMobile'),
    mDesktop: document.getElementById('mDesktop'),
  };

  function applyFabVisibility() {
    const forced = root.getAttribute('data-mode');
    const isMobileLike =
      forced === 'mobile' ||
      (forced !== 'desktop' && window.matchMedia('(max-width:1023px)').matches);

    if (menuFab) menuFab.style.display = isMobileLike ? 'block' : 'none';
  }

  function setMode(m) {
    if (m === 'auto') {
      root.removeAttribute('data-mode');
    } else {
      root.setAttribute('data-mode', m);
    }
    localStorage.setItem('mode', m);
    applyFabVisibility();

    if (m === 'desktop') {
      if (sidebar && sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
      }
      if (backdrop && backdrop.classList.contains('show')) {
        backdrop.classList.remove('show');
      }
      if (menuFab) menuFab.setAttribute('aria-expanded', 'false');
    }
  }

  btn.auto    && btn.auto.addEventListener('click',    () => setMode('auto'));
  btn.mobile  && btn.mobile.addEventListener('click',  () => setMode('mobile'));
  btn.desktop && btn.desktop.addEventListener('click', () => setMode('desktop'));
  btn.mAuto   && btn.mAuto.addEventListener('click',   () => setMode('auto'));
  btn.mMobile && btn.mMobile.addEventListener('click', () => setMode('mobile'));
  btn.mDesktop&& btn.mDesktop.addEventListener('click',() => setMode('desktop'));

  setMode(localStorage.getItem('mode') || 'auto');
  window.addEventListener('resize', applyFabVisibility);
  new MutationObserver(applyFabVisibility).observe(root, {
    attributes: true, attributeFilter: ['data-mode']
  });
})();

/* ====== 深色 UI 切換 ====== */
const toggleDark = document.getElementById('toggleDark');
if(localStorage.getItem('theme')==='light') document.documentElement.classList.add('light');
toggleDark.onclick=()=>{
  document.documentElement.classList.toggle('light');
  localStorage.setItem('theme', document.documentElement.classList.contains('light')?'light':'dark');
};

/* ====== 生成表格（飲食注意） ====== */
(function renderTable(){
  const helper = {
    "昆蟲食蜥蜴/守宮": { how:"餌蟲薄灑粉、UVB到位用無D3鈣", pace:"含D3鈣 1–2次/週（無UVB/幼體）" },
    "草食蜥蜴/陸龜":   { how:"草為主、多綠葉菜、鈣粉薄灑",   pace:"鈣 2–3餐/週；綜維 每7–14天" },
    "水龜/半水龜":     { how:"烏賊骨/高鈣餅、少量補粉",       pace:"補粉 2–4週/次" },
    "蛇":               { how:"維持整隻獵物",                 pace:"依體況 7–14日/餐" },
    "兔/天竺鼠/龍貓":   { how:"逐步換食、高纖維維持",           pace:"益生菌 2–4週評估" },
    "蜜袋鼯":           { how:"依既定配方 + 規律鈣粉",         pace:"鈣 小量多次/週" },
    "蠍/蜘蛛":         { how:"專注餌料品質",                   pace:"餌料殘渣即時清" },
  };
  const body = document.getElementById('tbody');
  body.innerHTML = Object.keys(DATA).map(name=>{
    const d=DATA[name];
    const avoidHtml = [
      d.details.avoid ? `<span class="t-red">⛔ ${d.details.avoid.replace(/^⛔\s*/,'')}</span>` : '',
      d.details.not   ? `<span class="t-redlite">⚠️ ${d.details.not.replace(/^⚠️\s*/,'')}</span>` : ''
    ].filter(Boolean).join('、');

    return `<tr>
      <td data-label="物種分群">${name}</td>
      <td data-label="必需"  class="t-green">${d.details.essential || '—'}</td>
      <td data-label="可選"  class="t-yellow">${d.details.optional || '—'}</td>
      <td data-label="⛔ 避免 / ⚠️ 不建議">${avoidHtml || '—'}</td>
      <td data-label="給法"  class="t-sky">${helper[name].how}</td>
      <td data-label="節奏"  class="t-purple">${helper[name].pace}</td>
    </tr>`;
  }).join('');
})();

/* ====== 生成「疾病風險／基因缺陷」表 ====== */
(function renderRisks(){
  const tbody = document.getElementById('riskBody');
  const esc = s => (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;');
  tbody.innerHTML = Object.entries(RISKS).map(([name, d])=>{
    const list = arr => '<ul>' + arr.map(x=>`<li>${esc(x)}</li>`).join('') + '</ul>';
    return `<tr>
      <td data-label="物種分群">${esc(name)}</td>
      <td data-label="常見疾病／營養症">${list(d.diseases)}</td>
      <td data-label="基因缺陷／爭議品系">${list(d.genetics)}</td>
    </tr>`;
  }).join('');
})();

/* ====== 段位跳轉（1/2/3） ====== */
function mountPager(pager){
  const box=document.querySelector(pager.dataset.pager); if(!box) return;
  function jump(dir, step){
    const span = box.clientWidth * (step===1?0.33:step===2?0.66:0.95);
    box.scrollTo({ left: box.scrollLeft + (dir==='right'?span:-span), behavior:'smooth' });
  }
  pager.addEventListener('click', e=>{
    const b=e.target.closest('.btn'); if(!b) return;
    const dir=b.dataset.dir, step=+b.dataset.step||1;
    if(dir) jump(dir, step);
  });
}
document.querySelectorAll('.pager[data-pager]').forEach(mountPager);

/* ====== 行動版抽屜：FAB、背景、右滑開啟 ====== */
const sidebar = document.getElementById('sidebar');
const backdrop = document.getElementById('backdrop');
const menuFab = document.getElementById('menuFab');
function openDrawer(){ sidebar.classList.add('open'); backdrop.classList.add('show'); menuFab.setAttribute('aria-expanded','true'); }
function closeDrawer(){ sidebar.classList.remove('open'); backdrop.classList.remove('show'); menuFab.setAttribute('aria-expanded','false'); }
menuFab.addEventListener('click', ()=> sidebar.classList.contains('open') ? closeDrawer() : openDrawer());
function isMobileLike(){
  const m = document.documentElement.getAttribute('data-mode');
  return m === 'mobile' || (m !== 'desktop' && matchMedia('(max-width:1023px)').matches);
}

// 點側欄任一目錄 → 切換面板並關抽屜（手機 / 自動模式）
document.addEventListener('click', (e) => {
  const link = e.target.closest('.navlink');
  if (!link) return;
  showPanel(link.dataset.section);
  if (isMobileLike() && sidebar.classList.contains('open')) closeDrawer();
});

// Esc 關抽屜；視窗變成桌機寬度自動收回
document.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeDrawer(); });
addEventListener('resize', () => { if (!isMobileLike()) closeDrawer(); });

backdrop.addEventListener('click', closeDrawer);
function isMobileLike(){
  const root = document.documentElement;
  const forced = root.getAttribute('data-mode');
  return forced === 'mobile' ||
         (forced !== 'desktop' && window.matchMedia('(max-width:1023px)').matches);
}

// 邊緣右滑手勢：起點靠近左緣且向右快速滑動時開啟
(function edgeSwipeOpen(){
  let x0=null, y0=null, t0=0;
  function onStart(e){
    const t=e.touches?e.touches[0]:e;
    x0=t.clientX; y0=t.clientY; t0=Date.now();
  }
  function onEnd(e){
    if(x0==null) return;
    const t=e.changedTouches?e.changedTouches[0]:e;
    const dx=t.clientX-x0, dy=t.clientY-y0, dt=Date.now()-t0;
    const nearLeft = x0<=24;
    if(nearLeft && dx>60 && Math.abs(dx)>Math.abs(dy) && dt<500){
      openDrawer();
    }
    x0=y0=null;
  }
  document.addEventListener('touchstart', onStart, {passive:true});
  document.addEventListener('touchend', onEnd, {passive:true});
})();

/* ====== 來源資料 ====== */
document.getElementById('now').textContent = new Date().toLocaleString();
const references = [
  { url: "https://www.merckvetmanual.com/management-and-nutrition/nutrition-exotic-and-zoo-animals/nutrition-in-reptiles", note: "MSD Vet Manual：Reptile & Exotic Nutrition" },
  { url: "https://vcahospitals.com/know-your-pet/common-diseases-of-tortoises", note: "VCA：陸龜常見疾病/金字塔背" },
  { url: "https://www.petmd.com/reptile/conditions/musculoskeletal/metabolic-bone-disease-mbd-reptiles", note: "PetMD：爬蟲 MBD（Ca/D3）" },
  { url: "https://www.merckvetmanual.com/management-and-nutrition/nutrition-exotic-and-zoo-animals/nutrition-in-snakes", note: "MSD：蛇類營養/照護" },
  { url: "https://www.dvm360.com/view/how-i-treat-gastrointestinal-stasis-small-herbivores-proceedings", note: "DVM360：小型草食哺乳 GI stasis" },
  { url: "https://www.merckvetmanual.com/all-other-pets/rabbits/disorders-and-diseases-of-rabbits", note: "MSD：兔—子宮腺癌等" },
  { url: "https://www.merckvetmanual.com/all-other-pets/guinea-pigs/disorders-and-diseases-of-guinea-pigs", note: "MSD：天竺鼠—維他命C缺乏" },
  { url: "https://www.merckvetmanual.com/exotic-and-laboratory-animals/sugar-gliders/overview-of-sugar-gliders", note: "MSD：蜜袋鼯—概論/營養" },
  { url: "https://www.merckvetmanual.com/multimedia/table/feeding-your-sugar-glider", note: "MSD：蜜袋鼯餵食表" },
  { url: "https://pmc.ncbi.nlm.nih.gov/articles/PMC7258705/", note: "GI stasis 綜述（2020）" },
  { url: "https://pmc.ncbi.nlm.nih.gov/articles/PMC9377635/", note: "球蟒 Spider 內耳變異與 wobble（2022）" },
  { url: "https://pmc.ncbi.nlm.nih.gov/articles/PMC4935766/", note: "豹紋守宮 Cryptosporidium varanii（2016）" }
];
document.getElementById('dev-refs').innerHTML =
  references.map(r => `<li><a class="link" href="${r.url}" target="_blank" rel="noopener">${r.note}</a></li>`).join('');

/* ====== 新圖表應用 ====== */
let chartAppReady = false;
let chart;                  // Chart.js instance
let chartType = 'pie';      // 'pie' | 'bar'
let current = Object.keys(DATA)[2] || Object.keys(DATA)[0];
let focusKey = null;        // 'essential' | 'optional' | 'avoid' | 'not' | null
let notedIndex = null;      // 0..3 或 null

const $ = sel => document.querySelector(sel);
const LABELS = { essential:'必需', optional:'可選', avoid:'避免', not:'不建議' };

function getTextOf(d){
  return {
    essential: d.details.essential || '—',
    optional:  d.details.optional  || '—',
    avoid:     d.details.avoid     || '—',
    not:       d.details.not       || '—',
  };
}
function datasetFor(spec){
  const d = DATA[spec];
  const vals = [d.essential,d.optional,d.avoid,d.not];
  return { d, vals, sum: vals.reduce((a,b)=>a+b,0), text: getTextOf(d) };
}
function percent(v, sum){ return sum ? Math.round(v*100/sum) : 0; }
function keyByIndex(i){ return ['essential','optional','avoid','not'][i]; }

function syncToolbar(){
  document.documentElement.setAttribute('data-ctype', chartType);
  document.querySelectorAll('#cToolbar .btn')
    .forEach(b=>b.classList.toggle('active', b.dataset.ctype===chartType));
}
function setChartType(t){ chartType=t; syncToolbar(); renderChart(); }

function renderSpeciesChips(){
  const wrap = $('#speciesChips'); wrap.innerHTML='';
  Object.keys(DATA).forEach(name=>{
    const b=document.createElement('button');
    b.className='chip'; b.textContent=name;
    b.onclick=()=>{ current=name; focusKey=null; notedIndex=null; renderAll(); };
    if(name===current) b.classList.add('active');
    wrap.appendChild(b);
  });
}

function mountLegend(text){
  $('#l-eg').textContent = text.essential;
  $('#l-op').textContent = text.optional || '—';
  $('#l-av').textContent = text.avoid || '—';
  $('#l-no').textContent = text.not   || '—';
  document.querySelectorAll('.legend .item').forEach((it)=>{
    const key = it.dataset.key;
    it.onclick = () => {
      focusKey = (focusKey===key?null:key);
      notedIndex = ['essential','optional','avoid','not'].indexOf(key);
      highlightBlocks();
      showNoteAtIndex(notedIndex);
    };
  });
}

function renderBlocks(){
  const { d, sum, text } = datasetFor(current);
  const map = [
    ['essential','green'],
    ['optional','yellow'],
    ['avoid','red'],
    ['not','redlite'],
  ];
  const box = $('#blocks'); box.innerHTML = '';
  map.forEach(([key, tone])=>{
    const pct = percent(d[key], sum);
    const el = document.createElement('div');
    el.className = `blk ${tone}`; el.dataset.key = key;
    el.innerHTML = `
      <h4>${LABELS[key]}（ ${pct}% ）</h4>
      <div>${(text[key]||'—')
        .replace(/⛔/g,'<span style="color:#ff6b6b">⛔</span>')
        .replace(/⚠️/g,'<span style="color:#facc15">⚠️</span>')}</div>`;
    el.onclick=()=>{ 
      const idx = ['essential','optional','avoid','not'].indexOf(key);
      focusKey=(focusKey===key?null:key);
      notedIndex = (notedIndex===idx ? null : idx);
      highlightBlocks(); 
      showNoteAtIndex(notedIndex);
    };
    box.appendChild(el);
  });
  highlightBlocks();
}
function highlightBlocks(){
  document.querySelectorAll('#blocks .blk').forEach(el=>{
    el.classList.toggle('hl', focusKey && el.dataset.key===focusKey);
  });
}

function showNoteAtIndex(idx){
  const note = $('#note');
  if(chart==null || idx==null || idx<0){ note.hidden = true; return; }
  const { d, sum, text } = datasetFor(current);
  const key = keyByIndex(idx);
  const label = LABELS[key];
  const val = d[key];
  const pct = percent(val, sum);
  note.innerHTML = `
    <div class="head"><span class="dot" style="background:${COLORS[key]}"></span>${label} · ${val}（${pct}%）</div>
    <div>${text[key] || '—'}</div>
  `;
  const elem = chart.getDatasetMeta(0).data[idx];
  if(!elem){ note.hidden = true; return; }
  const pos = elem.tooltipPosition();
  const canvas = chart.canvas;
  const parent = $('#chartBox');
  const rectCanvas = canvas.getBoundingClientRect();
  const rectParent = parent.getBoundingClientRect();
  const left = (rectCanvas.left - rectParent.left) + pos.x;
  const top  = (rectCanvas.top  - rectParent.top)  + pos.y;
  note.style.left = left + 'px';
  note.style.top  = top  + 'px';
  note.hidden = false;
}

function renderChart(){
  const ctx = $('#chartCanvas').getContext('2d');
  if(chart) chart.destroy();
  const { d, vals, sum, text } = datasetFor(current);
  const labels = [LABELS.essential, LABELS.optional, LABELS.avoid, LABELS.not];
  const colors = [COLORS.essential, COLORS.optional, COLORS.avoid, COLORS.not];
  $('#currentName').textContent = current;
  syncToolbar();

  if(window.Chart){
    Chart.defaults.font.family = getComputedStyle(document.body).fontFamily;
    Chart.defaults.devicePixelRatio = window.devicePixelRatio || 1;
  }

  const baseTooltip = { callbacks:{ label:(c)=>`${c.label}: ${c.raw}（${Math.round(c.raw*100/Math.max(1,sum))}%）` } };

  if(chartType==='pie'){
    chart = new Chart(ctx,{
      type:'pie',
      data:{ labels, datasets:[{ data: vals, backgroundColor: colors, borderWidth:2 }] },
      options:{
        responsive:true, maintainAspectRatio:true, aspectRatio:1,
        plugins:{ legend:{ display:false }, tooltip: baseTooltip },
        onClick:(_, els)=>{
          if(!els.length){ notedIndex=null; showNoteAtIndex(null); return; }
          const idx = els[0].index;
          const key = keyByIndex(idx);
          focusKey = (focusKey===key ? null : key);
          notedIndex = (notedIndex===idx ? null : idx);
          highlightBlocks();
          showNoteAtIndex(notedIndex);
        }
      }
    });
  }else{
    chart = new Chart(ctx,{
      type:'bar',
      data:{ labels, datasets:[{ label:'四類指標', data: vals, backgroundColor: colors, borderRadius:6 }] },
      options:{
        responsive:true, maintainAspectRatio:false,
        scales:{
          y:{ beginAtZero:true, ticks:{ precision:0 } },
          x:{ ticks:{ color:'#cbd5e1' } }
        },
        plugins:{ legend:{ display:false }, tooltip: baseTooltip },
        onClick:(_, els)=>{
          if(!els.length){ notedIndex=null; showNoteAtIndex(null); return; }
          const idx = els[0].index;
          const key = keyByIndex(idx);
          focusKey = (focusKey===key ? null : key);
          notedIndex = (notedIndex===idx ? null : idx);
          highlightBlocks();
          showNoteAtIndex(notedIndex);
        }
      }
    });
  }
  showNoteAtIndex(notedIndex);
}

function ensureChartApp(){
  if(chartAppReady) return;
  document.getElementById('cToolbar').addEventListener('click', (e)=>{
    const b=e.target.closest('.btn[data-ctype]'); if(!b) return;
    setChartType(b.dataset.ctype);
  });
  chartAppReady = true;
  renderAll();
}

function renderAll(){
  const { text } = datasetFor(current);
  renderSpeciesChips();
  mountLegend(text);
  renderBlocks();
  renderChart();
}

/* ====== 左右「滑手勢」換面板（保留），避免與抽屜衝突 ====== */
(function swipePanels(){
  let x0=null, y0=null, t0=0;
  function onStart(e){ const t=e.touches?e.touches[0]:e; x0=t.clientX; y0=t.clientY; t0=Date.now(); }
  function onEnd(e){
    if(x0==null) return;
    const t=e.changedTouches?e.changedTouches[0]:e;
    const dx=t.clientX-x0, dy=t.clientY-y0, dt=Date.now()-t0;
    const startedAtEdge = x0<=24;
    x0=y0=null;
    if(startedAtEdge && dx>60 && Math.abs(dx)>Math.abs(dy) && dt<600){ return; }
    if(Math.abs(dx)>60 && Math.abs(dx)>Math.abs(dy) && dt<600){
      const list = navlinks;
      const idx = list.findIndex(a=>a.classList.contains('active'));
      const next = dx<0 ? Math.min(list.length-1, idx+1) : Math.max(0, idx-1);
      showPanel(list[next].dataset.section);
    }
  }
  document.addEventListener('touchstart', onStart, {passive:true});
  document.addEventListener('touchend', onEnd, {passive:true});
})();

/* ====== 初始化 ====== */
const initial = (location.hash.match(/view=(\w+)/)||[])[1] || 'table';
applyView(initial);
// ====== Topbar「↩︎ 切換 App」按鈕 ======
(function(){
  const btn = document.getElementById('toApps');
  if(!btn) return;
  function mobileLike(){
    const root = document.documentElement;
    const forced = root.getAttribute('data-mode');
    return forced === 'mobile' || (forced !== 'desktop' && matchMedia('(max-width:1023px)').matches);
  }
  function update(){
    const active = document.querySelector('.panel.active')?.dataset.panel;
    btn.style.display = active === 'apps' ? 'none' : '';
  }
  const _showPanel = showPanel;
  showPanel = function(name){
    _showPanel(name);
    update();
  };
  btn.addEventListener('click', ()=>{
    showPanel('apps');
    if(mobileLike() && typeof closeDrawer==='function') closeDrawer();
    document.getElementById('content')?.scrollTo({top:0, behavior:'smooth'});
  });
  update();
})();
</script>
</body>
</html>
